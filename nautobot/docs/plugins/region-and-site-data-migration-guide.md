# Region and Site Related Data Model Migration Guide

`Region` and `Site` models are collapsed into `Location` in Nautobot V2.0. As a result, all the `Region` and `Site` related data models are being migrated to use `Location` as well. Below is a comprehensive guide for Nautobot App developers to migrate their `Region` and `Site` related data models to `Location`.

We will be using `ExampleModel` as a relatively simple and hands-on example throughout this guide to better your understanding of the migration process.

## Add Location Fields to Site and Region Related Data Models

`ExampleModel` right now has a `site` ForeignKey field but it does not have a `location` ForeignKey field. We need to add one before we run any other migrations in this guide.

!!! note
    You can skip this step your data models already have both `site`/`region` fields and a `location` field.

```python
# models.py

class ExampleModel(OrganizationalModel):
    site = models.ForeignKey(to="dcim.Site", on_delete=models.PROTECT, blank=True, null=True)
    name = models.CharField(max_length=20, help_text="The name of this Example.")
    number = models.IntegerField(default=100, help_text="The number of this Example.")
    csv_headers = ["name", "number"]

    class Meta:
        ordering = ["name"]
...
```

**DO NOT** delete the `site` ForeignKey field yet.

```python
# models.py

class ExampleModel(OrganizationalModel):
    site = models.ForeignKey(to="dcim.Site", on_delete=models.PROTECT, blank=True, null=True)
    location = models.ForeignKey(to="dcim.Location", on_delete=models.PROTECT, blank=True, null=True)
    name = models.CharField(max_length=20, help_text="The name of this Example.")
    number = models.IntegerField(default=100, help_text="The number of this Example.")
    csv_headers = ["name", "number"]

    class Meta:
        ordering = ["name"]
...
```

Make the migration file by running:

```shell
nautobot-server makemigrations [app_name] -n [migration_name]
nautobot-server makemigrations example_plugin -n add_location_field_to_example_model
```

Apply the migration file by running:

```shell
nautobot-server migrate [app_name]
nautobot-server migrate example_plugin
```

## Create an Empty Migration File to Manually Migrate the Data

After you make sure that all `Site`/`Region` related models have `location` fields on them, it is time to migrate `Site`/`Region` Data to `Location`.

We have to create an empty migration file and run an manual migration.

We can do that by creating a migration file first:

```shell
nautobot-server makemigrations [app_name] -n [migration_file_name] --empty
nautobot-server makemigrations example_plugin -n migrate_app_data_from_site_to_location --empty
```

The empty migration file will look like this, the only dependency is our previous migration that added a `location` ForeignKey field to our `ExampleModel`:

```python
# Generated by Django 3.2.17 on 2023-02-22 15:38
# 0008_migrate_example_model_data_from_site_to_location

from django.db import migrations

class Migration(migrations.Migration):
    dependencies = [
        ("example_plugin", "0007_add_location_field_to_example_model"),
    ]
    operations = []
```

First we need to add a mandatory dependency to the migration file, namely `("dcim", "0030_migrate_region_and_site_data_to_locations")`. This dependent migration is very important as it creates the `Site`/`Region` `LocationType` locations for you to migrate your data to.

**Without it, your manual migration might not work!**

```python
# Generated by Django 3.2.17 on 2023-02-22 15:38
# 0008_migrate_example_model_data_from_site_to_location

from django.db import migrations

class  Migration(migrations.Migration):
    dependencies = [
        # The dcim migration creates the Site Type and Region Type Locations that
        # your data models are migrating to. It has to be run **before** this migration.
        ("dcim", "0030_migrate_region_and_site_data_to_locations"),
        ("example_plugin", "0007_add_location_field_to_example_model"),
    ]
    operations = []
```

Now we can write the function that does the manual migration. We need to query `ExampleModel` instances that have non-null `site` field and point their `location` field to "Site" `LocationType` locations that have the same names and other attributes as their respective `Sites`.

Below is what the function might look like:

```python

# Generated by Django 3.2.17 on 2023-02-22 15:38
# 0008_migrate_example_model_data_from_site_to_location

from django.db import migrations

def migrate_example_model_data_to_locations(apps, schema_editor):

    ExampleModel = apps.get("example_plugin", "examplemodel")
    LocationType = apps.get("dcim", "locationtype")
    Location = apps.get("dcim", "location")
    # Get "Site" LocationType
    site_location_type = LocationType.objects.get(name="Site")

    if ExampleModel.objects.exists():
        # Query ExampleModel instances with non-null site field
        example_models = ExampleModel.objects.filter(site__isnull=False).select_related("site", "location")
        for example_model in example_models:
            site_name = example_model.site.name
            # Point the location field to the corresponding "Site" LocationType Location
            # with the same name.
            example_model.location = Location.objects.get(location_type=site_location_type, name=site_name)
            ExampleModel.objects.bulk_update(example_models, ["location"], 1000)

class  Migration(migrations.Migration):
    dependencies = [
        # The dcim migration creates the Site Type and Region Type Locations that
        # your data models are migrating to. It has to be run **before** this migration.
        ("dcim", "0030_migrate_region_and_site_data_to_locations"),
        ("example_plugin", "0007_add_location_field_to_example_model"),
    ]
    operations = []

```

!!! important
    If your data models already have both `site`/`region` fields and a `location` field, it is important that you add `location__isnull=True` to the query. This will filter out the data model instances that already have `Location` instances assigned to their `location` fields. `Location` instances provide more specificity than `Site` instances, we do not want to lose that in the data migration and `location__isnull=True` prevents that loss from the data migration overriding the original `location` field value.

    For example:

    ```python
    example_models = ExampleModel.objects.filter(site__isnull=False, location__isnull=True).select_related("site", "location")
    ```

Finally, we need to add `migrations.RunPython` to the `operations` attribute in the migration class to execute this function when the migration is applied:

```python

# Generated by Django 3.2.17 on 2023-02-22 15:38
# 0008_migrate_example_model_data_from_site_to_location

from  django.db  import  migrations

def migrate_example_model_data_to_locations(apps, schema_editor):

    ExampleModel = apps.get("example_plugin", "examplemodel")
    LocationType = apps.get("dcim", "locationtype")
    Location = apps.get("dcim", "location")
    # Get "Site" LocationType
    site_location_type = LocationType.objects.get(name="Site")

    if  ExampleModel.objects.exists():
        # Query ExampleModel instances with non-null site field
        example_models = ExampleModel.objects.filter(site__isnull=False).select_related("site", "location")
        for  example_model  in  example_models:
            site_name = example_model.site.name
            # Point the location field to the corresponding "Site" LocationType Location
            # with the same name.
            example_model.location = Location.objects.get(location_type=site_location_type, name=site_name)
            ExampleModel.objects.bulk_update(example_models, ["location"], 1000)

class Migration(migrations.Migration):
    dependencies = [
        # The dcim migration creates the Site Type and Region Type Locations that
        # your data models are migrating to. It has to be run **before** this migration.
        ("dcim", "0030_migrate_region_and_site_data_to_locations"),
        ("example_plugin", "0007_add_location_field_to_example_model"),
    ]
    operations = [
        migrations.RunPython(
            # Execute the function
            code=migrate_example_model_data_to_locations,
            reverse_code=migrations.operations.special.RunPython.noop,
        )
    ]

```

## Remove Site/Region Related Fields from Migrated Data Models

After you data migration is successful, we need to remove the `site`/`region` fields from your data model. You can do that by simply removing the `site`/`region` attributes from your model class:

```python

# models.py
class  ExampleModel(OrganizationalModel):
    # note that site field is gone
    location = models.ForeignKey(to="dcim.Location", on_delete=models.PROTECT, blank=True, null=True)
    name = models.CharField(max_length=20, help_text="The name of this Example.")
    number = models.IntegerField(default=100, help_text="The number of this Example.")
    csv_headers = ["name", "number"]

    class  Meta:
        ordering = ["name"]
...

```

After removing the `site` attribute, make the migration file by running:

```shell

nautobot-server makemigrations [app_name] -n [migration_name]
nautobot-server makemigrations example_plugin -n remove_site_field_from_example_model

```

The migration file might look like this:

```python

# Generated by Django 3.2.17 on 2023-02-22 17:09
# 0009_remove_site_field_from_example_model.py

from  django.db  import  migrations

class  Migration(migrations.Migration):

    dependencies = [
        ('example_plugin', '0008_migrate_example_model_data_from_site_to_location'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='examplemodel',
            name='site',
        ),
    ]

```

!!! important
    Before you apply this migration, you have to add an `run_before` attribute in this migration file to make sure that you remove `site`/`region` fields before `Site` and `Region` models themselves are removed. **Without it, your migration files might be out of order and your app will not start**.

```python
# Generated by Django 3.2.17 on 2023-02-22 17:09
# 0009_remove_site_field_from_example_model.py

from django.db import migrations

class Migration(migrations.Migration):
    
    # Ensure this migration is run before the migration that removes Region and Site Models
    run_before = [
        ("dcim", "0034_remove_region_and_site"),
    ]
    dependencies = [
        ("example_plugin", "0008_migrate_example_model_data_from_site_to_location"),
    ]

    operations = [
        migrations.RemoveField(
            model_name="examplemodel",
            name="site",
        ),
    ]
```

Apply the migration file by running:

```shell
nautobot-server migrate [app_name]
nautobot-server migrate example_plugin
```
