{% extends "base.html" %}
{% load helpers %}
{% load static %}

{% block extra_styles %}
<style>
    a.tile,
    a.tile:hover,
    a.tile:focus,
    a.tile:visited {
        color: inherit;
        text-decoration: none;
    }

    .tile-header {
        display: block;
    }

    .tile-header h2 {
        margin-bottom: 5px;
        margin-top: 0;
    }

    .tile-description {
        margin-top: 10px;
    }

    .app-details {
        column-gap: 20px;
        display: flex;
        flex-wrap: wrap;
    }

    .app-details dt {
        margin-top: 20px;
    }

    .app-details ul {
        list-style: none;
        padding: 0;
    }

    .app-details > :last-child {
        flex: 1;
    }
</style>
{% endblock %}

{% block content %}
    <div class="pull-right noprint">
        <a class="btn btn-primary" href="{% url 'apps:apps_list' %}">See Installed Apps</a>
    </div>

    <h1>{% block title %}Apps Marketplace{% endblock %}</h1>

    <div class="row">
        <div class="col-md-12">
            <section class="tiles">
                {% for app in apps %}
                    <a class="tile clickable" data-app="{{ app.package_name }}" href="?app={{ app.package_name }}">
                        <header class="tile-header">
                            <img
                                alt="{{ app.name }}"
                                src="{% if app.icon|default:None != None %}{{ app.icon }}{% else %}{% static 'img/nautobot_icon_192x192.png' %}{% endif %}"
                                height="64"
                                width="64"
                            />

                            <h2>{{ app.name }}</h2>

                            {% for use_case in app.use_cases %}
                                <label class="label label-default">{{ use_case }}</label>
                            {% endfor %}
                        </header>

                        <p class="tile-description">{{ app.headline }}</p>

                        <footer class="tile-footer">
                            <div>Author: {{ app.author }}</div>
                            <div>Availability: {{ app.availability }}</div>
                        </footer>
                    </a>

                    <div class="modal fade" tabindex="-1" id="modal-{{ app.package_name }}">
                        <div class="modal-dialog modal-lg" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>

                                    <h4 class="modal-title">{{ app.name }}</h4>
                                </div>

                                <div class="modal-body">
                                    <div class="app-details">
                                        <div>
                                            <img
                                                alt="{{ app.name }}"
                                                src="{% if app.icon|default:None != None %}{{ app.icon }}{% else %}{% static 'img/nautobot_icon_192x192.png' %}{% endif %}"
                                                height="64"
                                                width="64"
                                            />

                                            <dl>
                                                <dt class="text-muted text-uppercase">Author</dt>
                                                <dd>{{ app.author }}</dd>

                                                <dt class="text-muted text-uppercase">Availability</dt>
                                                <dd>{{ app.availability }}</dd>

                                                {% if app.requires|length > 0 %}
                                                    <dt class="text-muted text-uppercase">Requirements</dt>
                                                    <dd>
                                                        <ul>
                                                            {% for requirement in app.requires %}
                                                                {% for required_app in apps %}
                                                                    {% if required_app.package_name == requirement %}
                                                                        <li>
                                                                            <a
                                                                                data-app="{{ required_app.package_name }}"
                                                                                href="?app={{ required_app.package_name }}"
                                                                            >
                                                                                {{ required_app.name }}
                                                                            </a>
                                                                        </li>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            {% endfor %}
                                                        </ul>
                                                    </dd>
                                                {% endif %}

                                                <dt class="text-muted text-uppercase">Package name</dt>
                                                <dd><code>{{ app.package_name }}</code></dd>
                                            </dl>
                                        </div>

                                        <div>
                                            <h5>{{ app.headline }}</h5>

                                            <p>{{ app.description }}</p>

                                            {% if app.docs|default:None != None %}
                                                <p>
                                                    <span>
                                                        Docs:
                                                        <a href="{{ app.docs }}" target="_blank">{{ app.docs }}</a>
                                                    </span>
                                                </p>
                                            {% endif %}

                                            <div>
                                                {% for use_case in app.use_cases %}
                                                    <label class="label label-default">{{ use_case }}</label>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="modal-footer">
                                    <button class="btn btn-primary" data-dismiss="modal" type="button">
                                        Done
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </section>
            <div class="clearfix"></div>
        </div>
    </div>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script>
    (function () {
        let previousApp = new URLSearchParams(window.location.search).get("app");
        function toggleAppModal(app, action) {
            if (app) {
                const appModal = app ? document.querySelector(`#modal-${app}`) : null;
                const isShown = $(appModal).data("bs.modal")?.isShown;

                if (action === "hide" ? isShown : !isShown) {
                    $(appModal).modal(action);
                }

                previousApp = action === "hide" ? null : app;
            }
        }

        const appTilesContainer = document.querySelector(".tiles");
        const appModals = appTilesContainer.querySelectorAll(".modal");
        const appModalLinks = appTilesContainer.querySelectorAll("a[data-app]");

        for (const appModal of appModals) {
            $(appModal).on("hide.bs.modal", function () {
                const searchParams = new URLSearchParams(window.location.search);
                if (searchParams.get('app') === appModal.id.replace(/^modal-/, '')) {
                    searchParams.delete('app');
                    const nextSearch = searchParams.size > 0 ? `?${searchParams.toString()}` : '';
                    const nextURL = `${window.location.pathname}${nextSearch}${window.location.hash}`;
                    history.pushState(history.state, "", nextURL);
                }

                previousApp = null;
            });
        }

        for (const appModalLink of appModalLinks) {
            appModalLink.addEventListener("click", (event) => {
                event.preventDefault();
                history.pushState(history.state, "", appModalLink.href);

                toggleAppModal(previousApp, "hide");
                toggleAppModal(new URL(appModalLink.href).searchParams.get("app"), "show");
            });
        }

        window.addEventListener("popstate", function onPopState() {
            const searchParams = new URLSearchParams(window.location.search);
            const currentApp = searchParams.get("app");

            toggleAppModal(previousApp, 'hide');
            toggleAppModal(currentApp, 'show');
        });

        toggleAppModal(new URLSearchParams(window.location.search).get("app"), "show");
    })();
</script>
{% endblock javascript %}
