{% extends 'generic/object_create.html' %}
{% load static %}
{% load helpers %}
{% load form_helpers %}

{% block form %}
    <div class="card">
        <div class="card-header"><strong>Custom Field</strong></div>
        <div class="card-body">
            {% render_field form.label %}
            {% render_field form.grouping %}
            {% render_field form.key %}
            {% render_field form.type %}
            {% render_field form.weight %}
            {% render_field form.description %}
            {% render_field form.required %}
            {% render_field form.default %}
            {% render_field form.filter_logic %}
            {% render_field form.advanced_ui %}
        </div>
    </div>
    <div class="card">
        <div class="card-header"><strong>Assignment</strong></div>
        <div class="card-body">
            {% render_field form.content_types %}
        </div>
    </div>
    <div class="card" id="nb-scope-filter-form-container" hx-swap-oob="true" hx-on::after-settle="initializeScopeFilter(event)">
        <div class="card-header"><strong>Scope filter</strong></div>
        {% if content_type_selected %}
            <div class="card-body">
                <ul id="filter-tabs" class="nav nav-tabs">
                    {% if filter_form %}
                        <li role="presentation" class="nav-item">
                            <a class="nav-link{% if filter_form %} active{% endif %}"  href="#default-filter" role="tab" data-bs-toggle="tab">
                                Basic
                            </a>
                        </li>
                    {% endif %}
                    {% if dynamic_filter_form %}
                        <li role="presentation" class="nav-item">
                            <a class="nav-link position-relative{% if not filter_form %} active{% endif %}" href="#advanced-filter" role="tab" data-bs-toggle="tab">
                                Advanced
                            </a>
                        </li>
                    {% endif %}
                </ul>
                <div class="tab-content h-100">
                    {% if filter_form %}
                        <div id="default-filter" role="tabpanel" class="tab-pane fade{% if filter_form %} show active{% endif %} h-100 p-20">
                            <div class="h-100 vstack">
                                <div class="align-content-start flex-fill pb-20">
                                    {% for field in filter_form.hidden_fields %}
                                        {{ field }}
                                    {% endfor %}
                                    {% for field in filter_form.visible_fields %}
                                        {% if field.name == "q" %}
                                        <!--  Skip q field -->
                                        {% else %}
                                            <div class="nb-form-group">
                                                {% if field|widget_type == 'checkboxinput' %}
                                                    <label for="{{ field.id_for_label }}">{{ field }} {{ field.label }}</label>
                                                {% else %}
                                                    {{ field.label_tag }}
                                                    {{ field }}
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% else %}
            Please select content types first.
        {% endif %}
    </div>
    <div class="card">
        <div class="card-header"><strong>Validation Rules</strong></div>
        <div class="card-body">
            {% render_field form.validation_minimum %}
            {% render_field form.validation_maximum %}
            {% render_field form.validation_regex %}
        </div>
    </div>
    <div class="card">
        <div class="card-header"><strong>Custom Field Choices</strong></div>
        <div class="card-body overflow-auto">
            {% if choices.errors %}
                <div class="text-danger">
                    Please correct the error(s) below:

                    {% for choice in choices.forms %}
                        {% if choice.errors %}
                            {% for error in choice.errors.values %}{{ error }}{% endfor %}
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
            {{ choices.non_field_errors }}
            <table class="table" id="custom-field-choices">
                {{ choices.management_form }}
                {% for choice in choices.forms %}
                    {% if forloop.first %}
                        <thead>
                            <tr>
                                {% for field in choice.visible_fields %}
                                    <th>{{ field.label|capfirst }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                    {% endif %}
                    <tr class="formset_row-{{ choices.prefix }}">
                        {% for field in choice.visible_fields %}
                            <td>
                                {# Include the hidden fields in the form #}
                                {% if forloop.first %}
                                    {% for hidden in choice.hidden_fields %}
                                        {{ hidden }}
                                    {% endfor %}
                                {% endif %}
                                {{ field }}
                                {% if field.errors %}
                                    <ul>
                                        {% for error in field.errors %}
                                            {# Embed an HTML comment indicating the error for extraction by tests #}
                                            <!-- FORM-ERROR {{ field.name }}: {{ error }} -->
                                            <li class="text-danger">{{ error }}</li>
                                        {% endfor %}
                                    </ul>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </table>
        </div>
    </div>
    {% include 'inc/extras_features_edit_form_fields.html' %}
    {# Field for HTMX request to properly re-render scope filter form. It's need some adjustments if it's edit form. #}
    <input type="hidden" name="x-pk" value="{{ object.pk|default:'' }}"/>
{% endblock form %}

{% block javascript %}
    {{ block.super }}
    <script src="{% static 'jquery/jquery.formset.js' %}"></script>
    <script type="text/javascript">
        const slugify_prefer_underscores = true; // Custom fields work better in GraphQL (etc.) with underscore-based slugs
        $('.formset_row-{{ choices.prefix }}').formset({
            addText: '<span class="mdi mdi-plus-thick" aria-hidden="true"></span> Add another Custom Field Choice',
            addCssClass: 'btn btn-primary add-row',
            deleteText: '<span class="mdi mdi-trash-can-outline" aria-hidden="true"></span>',
            deleteCssClass: 'btn btn-danger delete-row',
            prefix: '{{ choices.prefix }}',
            formCssClass: 'dynamic-formset-{{ choices.prefix }}',
            keepFieldValues: 'input[type="number"]',
            added: jsify_form
        });

        {# Re-map select2 events to plain `change` event to make HTMX requests working. #}
        document.addEventListener("DOMContentLoaded", function() {
            $('#id_content_types').on('select2:select', function (e) {
                htmx.trigger('#id_content_types', 'change')
            });
            $('#id_content_types').on('select2:unselect', function (e) {
                htmx.trigger('#id_content_types', 'change')
            });
            $('#id_content_types').on('select2:clear', function (e) {
                htmx.trigger('#id_content_types', 'change')
            });
        });

        {# Function to re-initialize select2 selects after htmx re-renders part of template. #}
        const initializeScopeFilter = event => {
            window.nb.select2.initializeSelect2Fields(event.target)
        }
    </script>
{% endblock javascript %}
