{% extends "base.html" %}
{% load form_helpers %}
{% load helpers %}
{% load static %}

{% block extra_styles %}
    <style type="text/css">
        .button-container {
            margin-bottom: 24px;
        }
        #render_jinja_template_form textarea {
            resize: vertical;
            white-space: pre;
        }

    </style>
{% endblock extra_styles %}

{% block header %}
    <h1>{% block title %}Jinja Template Renderer{% endblock %}</h1>
    <hr>
{% endblock %}



{% block content %}
    <form class="form form-horizontal" onsubmit="handleFormSubmit(event)" id="render_jinja_template_form">
        <div class="row">
            <div class="col-lg-6 col-md-6">
                <div class="panel panel-default">
                    <div class="panel-heading"><strong>Template</strong></div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label class="col-md-3 control-label required" for="id_template_code">Jinja Template</label>
                            <div class="col-md-9">
                                <textarea cols="40" rows="10" class="form-control" id="id_template_code" required=""></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-md-3 control-label">Context Mode</label>
                        <div class="col-md-9">
                            <label class="radio-inline">
                                <input type="radio" name="context_mode" value="json" checked onchange="toggleContextMode('json')"> JSON Data
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="context_mode" value="object" onchange="toggleContextMode('object')"> Nautobot Object
                            </label>
                        </div>
                    </div>
                    <div class="form-group" id="json_context_group">
                        <label class="col-md-3 control-label" for="id_context">Data</label>
                        <div class="col-md-9">
                            <textarea cols="40" rows="10" class="form-control" placeholder="{}" id="id_context">{}</textarea>
                            <span class="help-block">Enter data in <a href="https://json.org/">JSON</a> format.</span>
                        </div>
                    </div>
                    <div class="form-group" id="object_content_type_group" style="display: none;">
                        <label class="col-md-3 control-label required" for="id_content_type">Content Type</label>
                        <div class="col-md-9">
                            <select class="form-control" id="id_content_type">
                                <option value="">---------</option>
                                {% for ct in content_types %}
                                    <option value="{{ ct.value }}">{{ ct.label }}</option>
                                {% endfor %}
                            </select>
                            <span class="help-block">Choose the type of object to use as template context.</span>
                        </div>
                    </div>
                    <div class="form-group" id="object_uuid_group" style="display: none;">
                        <label class="col-md-3 control-label required" for="id_object_uuid">Object UUID</label>
                        <div class="col-md-9">
                            <input type="text" class="form-control" id="id_object_uuid" placeholder="Enter object UUID">
                            <span class="help-block">Enter the UUID of the object to use as template context.</span>
                        </div>
                    </div>
                </div>
                <div class="button-container text-right">
                    <button type="submit" class="btn btn-primary">Render</button>
                </div>
            </div>
            <div class="col-lg-6 col-md-6">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <strong>Rendered Template</strong>
                        <button type="button" class="btn btn-inline btn-default copy-rendered-template" data-clipboard-target="#rendered_template">
                            <span class="mdi mdi-content-copy"></span>
                        </button>
                    </div>
                    <div class="panel-body">
                        <textarea readonly="readonly" cols="40" rows="23" class="form-control" placeholder="Rendered Template" id="rendered_template"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </form>
{% endblock content %}

{% block javascript %}
    {{ block.super }}
    <script>
        new ClipboardJS('.copy-rendered-template');
        const sanitize = function(string) {
            return string.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        };

        function toggleContextMode(mode) {
            const jsonGroup = document.getElementById("json_context_group");
            const contentTypeGroup = document.getElementById("object_content_type_group");
            const uuidGroup = document.getElementById("object_uuid_group");
            
            if (mode === "object") {
                jsonGroup.style.display = "none";
                contentTypeGroup.style.display = "block";
                uuidGroup.style.display = "block";
                
                // Clear JSON context and make it not required
                document.getElementById("id_context").value = "{}";
                
                // Make object fields required
                document.getElementById("id_content_type").setAttribute("required", "");
                document.getElementById("id_object_uuid").setAttribute("required", "");
            } else {
                jsonGroup.style.display = "block";
                contentTypeGroup.style.display = "none";
                uuidGroup.style.display = "none";
                
                // Clear object fields and make them not required
                document.getElementById("id_content_type").value = "";
                document.getElementById("id_object_uuid").value = "";
                document.getElementById("id_content_type").removeAttribute("required");
                document.getElementById("id_object_uuid").removeAttribute("required");
            }
        }


        async function handleFormSubmit(event) {
            event.preventDefault();

            const mode = document.querySelector("input[name=\"context_mode\"]:checked").value;
            const template_code = document.getElementById("id_template_code").value;
            
            let data = {
                template_code: template_code
            };

            if (mode === "object") {
                // Object mode - send content_type and object_uuid
                data.content_type = document.getElementById("id_content_type").value;
                data.object_uuid = document.getElementById("id_object_uuid").value;
                
                if (!data.content_type || !data.object_uuid) {
                    alert("Please select an object type and enter a UUID.");
                    return;
                }
            } else {
                // JSON mode - send context
                const context = document.getElementById("id_context");
                try {
                    data.context = JSON.parse(context.value);
                } catch (error) {
                    context.setCustomValidity("Invalid JSON");
                    context.reportValidity();
                    context.setCustomValidity("");
                    return;
                }
            }

            try {
                const rendered_template = document.getElementById("rendered_template");
                rendered_template.innerHTML = "Loading...";
                const url = "{% url 'core-api:render_jinja_template' %}";

                const response = await fetch(url, {
                    method: "POST",
                    body: JSON.stringify(data),
                    headers: {"Content-Type": "application/json", "X-CSRFTOKEN": "{{ csrf_token }}"}
                });

                const responseData = await response.json();
                if (!response.ok) {
                    const msg = responseData.detail ? responseData.detail : response.statusText;
                    rendered_template.innerHTML = sanitize(`An error occurred:\n\n${msg}`);
                } else {
                    rendered_template.innerHTML = sanitize(responseData.rendered_template);
                }
            } catch (error) {
                rendered_template.innerHTML = sanitize(`An error occurred:\n\n${error.message}`);
            }
        }

        // Check for preselected values on page load
        document.addEventListener("DOMContentLoaded", function() {
            // Check if object was preselected via URL parameters (from Django context)
            const preselectedContentType = "{{ preselected_content_type|default:'' }}";
            const preselectedObjectUuid = "{{ preselected_object_uuid|default:'' }}";
            
            if (preselectedContentType && preselectedObjectUuid) {
                // Switch to object mode
                document.querySelector("input[name=\"context_mode\"][value=\"object\"]").checked = true;
                toggleContextMode("object");
                
                // Pre-populate fields
                document.getElementById("id_content_type").value = preselectedContentType;
                document.getElementById("id_object_uuid").value = preselectedObjectUuid;
                
                // Show notification
                console.log("Object pre-selected from URL");
            }
        });
    </script>
{% endblock javascript %}
