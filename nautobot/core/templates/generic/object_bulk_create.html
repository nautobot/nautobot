{% extends 'extras/job.html' %}
{% load helpers %}
{% load form_helpers %}

{% block job_form %}
{% render_field job_form.content_type %}
<ul class="nav nav-tabs" role="tablist">
    <li role="presentation" class="active"><a href="#csv-file" role="tab" data-toggle="tab">CSV File Upload</a></li>
    <li role="presentation"><a href="#csv-text" role="tab" data-toggle="tab">CSV Text Input</a></li>
</ul>
<div class="tab-content">
    <div role="tabpanel" class="tab-pane active" id="csv-file">
        {% render_field job_form.csv_file %}
    </div>
    <div role="tabpanel" class="tab-pane" id="csv-text">
        {% render_field job_form.csv_data %}
    </div>
</div>
<table class="table">
    <thead>
        <tr>
            <th>CSV Column</th>
            <th>Required</th>
            <th>Description</th>
        </tr>
    </thead>
    <tbody id="csv-fields-tbody"></tbody>
</table>
<p class="small text-muted">
    <i class="mdi mdi-check-bold"></i> Required columns <strong>must</strong> be specified for all
    objects.
</p>
<p class="small text-muted">
    <i class="mdi mdi-information-outline"></i> Related objects may be referenced by their UUID and/or by their natural key unique field combinations. e.g `location__name`, `location__parent__name`. You can find this information in the "Advanced" tab of any object's detail view.
</p>
{% endblock %}

{% block javascript %}
{{ block.super }}
<script>
    /* using jquery here because select2 doesn't fire native events - https://github.com/select2/select2/issues/1908 */
    $("#id_content_type").on("change", async (event) => {
        const response = await fetch(`{% url 'ui-api:csv-fields' %}?content-type-id=${event.target.value}`);
        const data = await response.json();

        const csv_data = document.getElementById("id_csv_data");
        csv_data.innerHTML = "";
        const tbody = document.getElementById("csv-fields-tbody");
        tbody.innerHTML = "";
        for (const field of data.fields) {
            let tr = document.createElement("tr");

            let td = document.createElement("td");
            td.innerHTML = `<code>${field.name}</code>`;
            tr.appendChild(td);

            td = document.createElement("td");
            if (field.required) {
                td.innerHTML = '<span class="text-success"><i class="mdi mdi-check-bold" title="Yes"></i></span>';
                if (csv_data.innerHTML != "") {
                    csv_data.innerHTML += ","
                }
                csv_data.innerHTML += field.name;
            } else {
                td.innerHTML = '<span class="text-danger"><i class="mdi mdi-close-thick" title="No"></i></span>';
            }
            tr.appendChild(td);

            td = document.createElement("td");
            if (field.choices) {
                let choicesHTML = "";
                for (const [value, label] of Object.entries(field.choices)) {
                    if (value) {
                        choicesHTML += `<tr><td><samp>${value}</samp></td><td>${label}</td></tr>`;
                    }
                }
                td.innerHTML += `
                    <button type="button" class="btn btn-link btn-xs pull-right" data-toggle="modal"
                            data-target="#${ field.name }_choices">
                        <i class="mdi mdi-help-circle"></i>
                    </button>
                    <div class="modal fade" id="${field.name}_choices" tabindex="-1" role="dialog">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                    <h4 class="modal-title"><code>${field.name}</code> Choices</h4>
                                </div>
                                <table class="table table-striped modal-body">
                                    <tr><th>Import Value</th><th>Label</th></tr>
                                    ${choicesHTML}
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            }
            if (field.help_text) {
                td.innerHTML += `${field.help_text}<br>`;
            } else if (field.label) {
                td.innerHTML += `${field.label}<br>`;
            }
            if (field.format) {
                td.innerHTML += `<small class="text-muted">Format: ${field.format}</small>`
            }

            tr.appendChild(td);
            tbody.appendChild(tr);
        }
    });

    if ($("#id_content_type").val()) {
        $("#id_content_type").change();
    }
</script>
{% endblock %}
