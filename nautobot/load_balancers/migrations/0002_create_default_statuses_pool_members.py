# Generated by Django 4.2.19 on 2025-02-13 03:05

from django.db import IntegrityError, migrations
from nautobot.apps.choices import ColorChoices
from nautobot.extras.management import export_metadata_from_choiceset

from nautobot_load_balancer_models.choices import LoadBalancerPoolMemberStatusChoices


def populate_load_balancer_pool_member_status_choices(apps, schema_editor):
    """Populate the status choices for the LoadBalancerPoolMember model."""

    color_map = {
        "Active": ColorChoices.COLOR_GREEN,
        "Maintenance": ColorChoices.COLOR_GREY,
        "Planned": ColorChoices.COLOR_CYAN,
        "Failed": ColorChoices.COLOR_RED,
        "Decommissioning": ColorChoices.COLOR_AMBER,
    }
    description_map = {
        "Active": "Unit is active",
        "Maintenance": "Unit is under maintenance",
        "Planned": "Unit has been planned",
        "Failed": "Unit has failed",
        "Decommissioning": "Unit is being decommissioned",
    }
    choices = export_metadata_from_choiceset(
        LoadBalancerPoolMemberStatusChoices,
        color_map=color_map,
        description_map=description_map,
        metadatamodel="status",
    )

    ContentType = apps.get_model("contenttypes", "ContentType")
    Status = apps.get_model("extras", "Status")

    content_type = ContentType.objects.get_for_model(
        apps.get_model("nautobot_load_balancer_models.LoadBalancerPoolMember")
    )
    for choice_kwargs in choices:
        name = choice_kwargs.pop("name")
        try:
            obj, _ = Status.objects.get_or_create(name=name, defaults=choice_kwargs)
            obj.content_types.add(content_type)
        except IntegrityError as err:
            raise SystemExit(
                f"Unexpected error while creating status {name} for nautobot_load_balancer_models.LoadBalancerPoolMember: {err}"
            ) from err


def clear_load_balancer_pool_member_status_choices(apps, schema_editor):
    """Clear the status choices for the LoadBalancerPoolMember model."""
    ContentType = apps.get_model("contenttypes", "ContentType")
    Status = apps.get_model("extras", "Status")

    content_type = ContentType.objects.get_for_model(
        apps.get_model("nautobot_load_balancer_models.LoadBalancerPoolMember")
    )
    statuses = Status.objects.filter(content_types=content_type).values_list("name", flat=True)

    for name in statuses:
        try:
            obj = Status.objects.get(name=name)
            obj.content_types.remove(content_type)
        except Exception as err:
            raise SystemExit(
                f"Unexpected error while removing nautobot_load_balancer_models.LoadBalancerPoolMember from status {name}: {err}"
            ) from err


class Migration(migrations.Migration):
    dependencies = [
        ("contenttypes", "0001_initial"),
        ("extras", "0001_initial_part_1"),
        ("nautobot_load_balancer_models", "0001_initial"),
    ]

    operations = [
        migrations.RunPython(
            code=populate_load_balancer_pool_member_status_choices,
            reverse_code=clear_load_balancer_pool_member_status_choices,
        ),
    ]
