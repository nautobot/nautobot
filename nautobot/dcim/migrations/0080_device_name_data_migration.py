# Generated by Django 4.2.24 on 2025-10-07 07:18

from constance.models import Constance
from django.db import migrations

from nautobot.core.utils.config import get_settings_or_config
from nautobot.dcim.choices import DeviceUniquenessChoices


def migrate_device_uniqueness_setting(apps, schema_editor):
    """
    Migrate deprecated DEVICE_NAME_AS_NATURAL_KEY setting to DEVICE_UNIQUENESS and DEVICE_NAME_REQUIRED.
    """
    try:
        old_value = get_settings_or_config("DEVICE_NAME_AS_NATURAL_KEY")
    except AttributeError:
        old_value = False
    new_value = DeviceUniquenessChoices.NAME if old_value else DeviceUniquenessChoices.LOCATION_TENANT_NAME

    # Update or create DEVICE_UNIQUENESS in Constance
    Constance.objects.update_or_create(
        key="DEVICE_UNIQUENESS",
        defaults={"value": new_value},
    )

    # cleanup: remove deprecated setting entry if it exists
    Constance.objects.filter(key="DEVICE_NAME_AS_NATURAL_KEY").delete()


def reverse_migrate_device_uniqueness_setting(apps, schema_editor):
    """
    Reverse migration set DEVICE_NAME_AS_NATURAL_KEY based on DEVICE_UNIQUENESS.
    """
    try:
        device_uniqueness = Constance.objects.get(key="DEVICE_UNIQUENESS").value
    except Constance.DoesNotExist:
        return

    if device_uniqueness == DeviceUniquenessChoices.NAME:
        Constance.objects.update_or_create(key="DEVICE_NAME_AS_NATURAL_KEY", defaults={"value": True})
    else:
        Constance.objects.update_or_create(key="DEVICE_NAME_AS_NATURAL_KEY", defaults={"value": False})

    # cleanup: remove DEVICE_UNIQUENESS setting entry if it exists
    Constance.objects.filter(key="DEVICE_UNIQUENESS").delete()


class Migration(migrations.Migration):
    dependencies = [
        ("dcim", "0079_remove_device_location_tenant_name_uniqueness"),
        ("constance", "0003_drop_pickle"),
    ]

    operations = [
        migrations.RunPython(
            migrate_device_uniqueness_setting,
            reverse_migrate_device_uniqueness_setting,
        ),
    ]
