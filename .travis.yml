# Linting/Testing available at https://config.travis-ci.com/explore
os: linux
dist: xenial

stages:
  - Linting
  - test
  # This assumes tags will only be used for version releases
  - name: "deploy-github"
    if: "tag IS present"
  - name: "deploy-pypi"
    if: "tag IS present"

services:
  - postgresql
  - redis

# The test stage will be a matrix of the python list * the env['jobs'] list
language: "python"
python:
  - "3.6"
  - "3.7"
  - "3.8"
  - "3.9"

env:
  global:
    - NAUTOBOT_SELENIUM_URL=http://localhost:4444/wd/hub 
    - INVOKE_NAUTOBOT_LOCAL=True
    - NAUTOBOT_INTEGRATION_TEST=True
  # jobs:
  #   - "INVOKE_NAUTOBOT_LOCAL=True TESTING_OPTIONS='--failfast'"
  #   - "INVOKE_NAUTOBOT_LOCAL=False TESTING_OPTIONS='--failfast --label nautobot.core.tests.integration' NAUTOBOT_INTEGRATION_TEST=True"

addons:
  postgresql: "9.6"
before_install:
  - pip install poetry
install:
  - poetry config virtualenvs.create false
  # Poetry 1.1.0 added parallel installation as an option;
  # unfortunately it seems to have some issues with installing/updating "requests" and "certifi"
  # while simultaneously atttempting to *use* those packages to install other packages.
  # For now we disable it.
  - poetry config installer.parallel false
  - poetry install
before_script:
  - psql -U postgres -c 'create database nautobot;'
  - pip install docker-compose
script:
  - invoke start --service selenium
  - invoke unittest --failfast --keepdb || travis_terminate 1
  - export NAUTOBOT_SELENIUM_HOST=$(hostname -f)
  - invoke unittest --failfast --keepdb --label nautobot.core.tests.integration || travis_terminate 1
  - invoke unittest-coverage || travis_terminate 1

jobs:
  fast_finish: true
  include:
    # Lint in python 3.9 for speed, install only the linting tools, skip poetry for this stage, saves ~1m
    - stage: "Linting"
      before_install:
        - pip install invoke black=="20.8b1" flake8=="3.9.2"  # Until there is a poetry install --dev-only install the linting tools here to speed up this step
        - curl -Lo /home/travis/bin/hadolint https://github.com/hadolint/hadolint/releases/download/v2.0.0/hadolint-Linux-x86_64
        - chmod +x /home/travis/bin/hadolint
      install: []
      services: []
      addons:
        postgresql: ""
      python: "3.9"
      before_script: []
      script: "invoke tests --lint-only"

    - stage: "deploy-github"
      before_script:
        - "pip install poetry"
      script:
        - "poetry version $TRAVIS_TAG"
        - "poetry build"
      deploy:
        provider: "releases"
        token: "$GITHUB_AUTH_TOKEN"
        file_glob: true
        file: "dist/*"
        skip_cleanup: true
        "on":
          all_branches: true

    - stage: "deploy-pypi"
      before_script:
        - "pip install poetry"
      script:
        - "poetry version $TRAVIS_TAG"
        - "poetry config pypi-token.pypi $PYPI_TOKEN"
        - "poetry publish --build"
