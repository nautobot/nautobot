# Linting available at https://config.travis-ci.com/explore
os: linux
dist: xenial
cache:
  directories:
    - /home/travis/docker_images
services:
  - postgresql
  - redis
  - docker
addons:
  postgresql: "9.6"
language: python
jobs:
  include:
    # - python: "3.6"
    # - python: "3.7"
    # - python: "3.8"
    # - python: "3.9"
    - stage: Docker Build
      python: "3.6"
      env:
        - PYTHON_VER=3.6
        - OVERRIDE_FILENAME=docker-compose.test.yml
      before_install:
        - pip install poetry docker-compose
      script:
        - invoke build
      after_script:
        - mkdir /home/travis/docker_images
        - docker save -o /home/travis/docker_images/images.tar $(docker images -a -q)
    - stage: Docker Integration Tests
      script:
        - invoke integration-tests
    - stage: Publish Docker Image (Develop)
      if: branch = develop #AND type = push 
      before_script:
        - docker load -i /home/travis/docker_images/images.tar || true
      script:
        - export COMMIT_DATE_TAG=develop-${TRAVIS_COMMIT:0:7}-$(date +%s)
        - 'echo Using tag: ${COMMIT_DATE_TAG}'
        - docker tag networktocode/nautobot:local networktocode/nautobot:latest-dev
        - docker tag networktocode/nautobot:local networktocode/nautobot:${COMMIT_DATE_TAG}
        - docker tag networktocode/nautobot:local ghcr.io/nautobot/nautobot:latest-dev
        - docker tag networktocode/nautobot:local ghcr.io/nautobot/nautobot:${COMMIT_DATE_TAG}
        - echo Sign into docker hub
        # - echo echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_USERNAME" --password-stdin || travis_terminate 1
        - echo Sign into Github Container Registry
        # - echo echo $GHCR_ACCESS_TOKEN | docker login ghcr.io -u $GHCR_USERNAME --password-stdin || travis_terminate 1
        - echo Pushing images
        - echo docker push networktocode/nautobot:latest-dev
        - echo docker push networktocode/nautobot:${COMMIT_DATE_TAG}
        - echo docker push ghcr.io/nautobot/nautobot:latest-dev
        - echo docker push ghcr.io/nautobot/nautobot:${COMMIT_DATE_TAG}
      after_script:
        - docker images
  allow_failures:
    - python: "3.9"
before_install:
  - pip install poetry
  - curl -Lo /home/travis/bin/hadolint https://github.com/hadolint/hadolint/releases/download/v2.0.0/hadolint-Linux-x86_64
  - chmod +x /home/travis/bin/hadolint
install:
  - poetry config virtualenvs.create false
  # Poetry 1.1.0 added parallel installation as an option;
  # unfortunately it seems to have some issues with installing/updating "requests" and "certifi"
  # while simultaneously atttempting to *use* those packages to install other packages.
  # For now we disable it.
  - poetry config installer.parallel false
  - poetry install --no-ansi
before_script:
  - psql --version
  - psql -U postgres -c 'SELECT version();'
  - psql -U postgres -c 'create database nautobot;'
  - docker pull ghcr.io/hadolint/hadolint
script:
  - poetry run ./scripts/cibuild.sh
